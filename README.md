# Searcher
Поиск изображений по текстовому запросу/фото

# Данные
В проекте используется датасет Flickr8k
https://www.kaggle.com/datasets/adityajn105/flickr8k.

В загруженном примере ограничение на считывание стоит первые 5000 описаний и, соответствующие им, 1000 картинок. В зависимости от количества картинок, некоторые методы могут дольше работать.

# Структура проекта
## Схема
![image](https://github.com/user-attachments/assets/66830afb-2605-44e8-9a78-98d6bf5a51b8)

Поисковик реализован в виде веб-приложения на Flask с поддержкой следующих функций: загрузка изображения или ввод текстового запроса, выбор модели кодирования (векторизации) и метода поиска, перевод текста на английский язык с помощью библиотеки Translator, так как модели работают эффективнее с английскими текстами, генерация вектора запроса и его сравнение с векторами из базы данных, вывод результатов поиска (топ-10 релевантных изображений с возможностью подгрузки следующих результатов). Для поиска по текстовому запросу есть возможность выбирать между моделями сравнения векторов, для поиска по загруженному изображению по умолчанию стоит косинусное сходство.

В качестве базы данных используется сервер PostgreSQL, в котором создаются итоговые таблицы с векторами и путями к изображениям. Для текстовых описаний сначала создаются таблицы со всеми векторами (т.е. по 5 описаний к каждой картинке), затем усреднённые значения. Для поиска используются последние чтобы исключить возможность повтора картинок и улучшить точность поисковых запросов.

## База данных

ERP-схема текстовых моделей

![image](https://github.com/user-attachments/assets/57e39426-5126-475d-aae6-fd4d9494edec)


Сначала данные из файла captions.txt загружаются в таблицу description. Затем, по image_path, в таблицу "name" заносятся image_path и соответствующий названию модели (берётся из name) преобразование описаний в векторы. После этого, полученные по одному image_path векторы усредняются и заносятся в таблицу "uniq_name".

Список name/uniq_name

    paraphrase-MiniLM-L6-v2
    all-MiniLM-L6-v2
    paraphrase-mpnet-base-v2
    all-mpnet-base-v2
    sentence-t5-base
    sentence-t5-large

Аналогичным образом хранятся векторы для сравнения через изображения, но этап с "усреднением" пропускается. Таблицы имеют названия {model_name}_vectors. Список modek_name

    regnet_y_16gf
    resnet50
    vgg16
    efficientnet_b0
    inception_v3
    convnext_base

Названия моделей соответствует используемым в коде
## Алгоритмы поиска
Сложность стандартных алгоритмов поиска

  - Косинуное O(m*n^2)

  - Манхэттэнское O(m*n^2)

  - Евклидово O(m*n^2)

m - кол-во строк, n - размерность векторов


Сложность модифицированных алгоритмов поиска

  - KD-дерево O(m * log(m) + log(m) * k)

  - HNSW O(m * log(m) + log(m) * k)

  - FAISS O(m + log(m) * k)

m - количество элементов, k - количество ближайших соседей

FAISS наиболее эффективный метод


## Структура кода

### main.py

Основной файл, запуск flask-приложения, выбор модели, настройка связи между исполняемыми файлами и шаблонами. Настраивается очистка загруженных изображений при достижении определённого размера, добавляются декоратораторы, отвечающие за загрузку нужных шаблонов и связь между клиентом/сервером. В зависимости от выбранных настроек выбирает метод поиска, модель, способ сравнения. Реализован перевод с других языков на английский для корректного считывания запросов при помощи googletrans 

### Download.py

Файл оформления таблиц для текстовых запросов. Считывает данные из captions.txt, создаёт 12 таблиц. Первые 6 - вспомогательные, где присутствуют векторы повторяющихся описаний для одного и того же изображения, вторые 6 - основные, с усреднёнными значениями векторов для корректного поиска. В функциях process_vectors, create_unique_vectors и в Images_db.py в функции process_vectors выставляется размер будущей базы данных. Количество изображений в базе данных - n, количество загружаемых описаний - 5*n.

### Images_db.py

Файл оформления таблиц для поиска по фото. Работает аналогично "Download.py". Происходит нормализация изображений, затем проходится цикл с использованием каждой модели для нужного количества изображений, размер выставляется в функции process_vectors.


### methods.py

Файл с методами сравнения текстовых векторов. В конце присутствует оценка сложностей каждого из алгоритмов.

### Images_methods.py

Файл с методом для сравнения изображений. Реализовано только косинусное сходство.

### Clean_Upload.py

Метод для очистки папки с загруженными изображениями. При достижении определённого размера, при запуске программы происходит очистка до нужного размера. Путь к папке с загруженными изображениями и максимальный размер выставляется в начале файла.

### config.py

Тут находится один метод - подключение к базе данных. Настройте в зависимости от подключаемого сервера

### Шаблоны
В папке templates находятся html шаблоны для двух страниц: поиск по запросу (Searcher.html) и поиск по изображению (Images.html)

# Запуск проекта

Загрузите файл с описаниями captions.txt в папку проекта. Там же создайте папку static и поместите туда изображения из датасета. 

Создайте файл config.py, и настройте в нём подключение к вашей базе данных

    import psycopg2
    
    def get_db_connection():
    conn = psycopg2.connect(
        dbname=DB_NAME,
        user=DB_USER,
        password=DB_PASSWORD,
        host=DB_HOST,
        port=DB_PORT
    )
    return conn

Запустите файл Download.py, предварительно выставив размер для создаваемых таблиц (для n изображений в таблицах uniq_name выставьте 5*n изображений в таблицах name. Будут созданы и заполнены таблицы для текстовых запросов

Запустите файл Images_db.py, предварительно выставив размер создаваемых таблиц. Будут созданы и заполнены таблицы для сравнения изображений.

Запустите файл main.py, дождитесь запуска и перейдите на локальный адрес http://127.0.0.1:5000/.

Вводите запрос на удобном для вас языке и нажимайте кнопку "искать". Выпадают 10 наиболее подходящих результатов, при прокрутке до конца страницы и нажатии на кнопку "ещё" выходят дополнительно 10 результатов (вплоть до 100). Аналогичная работа в поиске по изображению, но там загружается фото.
